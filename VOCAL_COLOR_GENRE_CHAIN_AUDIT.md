# Аудит связей: Вокал → Цвета → Жанры → Веса

## 1. Вокальные партии и цветовые гаммы эмоций

### Текущее состояние:
- ❌ **ПРОБЛЕМА**: В `vocal_techniques.py` нет прямой связи между вокальными техниками и цветами эмоций
- ✅ `EMOTION_TO_VOCAL_MAP` содержит маппинг эмоций → вокальные техники
- ❌ Но цвета эмоций не передаются в вокальные секции

### Где должна быть связь:
1. `studiocore/vocal_techniques.py` - `get_vocal_for_section()` получает эмоции, но не цвета
2. `studiocore/core_v6.py` - `_build_lyrics_sections_with_vocals()` создает секции с вокалом, но не добавляет цвета

### Необходимые исправления:
- Добавить передачу `color_profile` в `get_vocal_for_section()`
- Добавить поле `color_wave` в каждую секцию lyrics_sections
- Связать цвет секции с эмоцией секции через `EMOTION_COLOR_MAP`

---

## 2. Лирический жанр ↔ Эмоциональный профиль ↔ Музыкальный жанр

### Текущее состояние:
- ✅ `genre_weights.py` содержит логику конвертации лирических жанров в музыкальные
- ✅ `emotion_genre_matrix.py` связывает эмоции с жанрами
- ⚠️ **ПРОБЛЕМА**: Связь лирический жанр → эмоции → музыкальный жанр не всегда работает корректно

### Где происходит связь:
1. `studiocore/core_v6.py` - `_backend_analyze()` (строка ~1998):
   - Определяет `domain_genre` на основе TLP и эмоций
   - Но не всегда учитывает лирический жанр из текста

2. `studiocore/genre_weights.py`:
   - `score_domains()` - оценивает домены на основе feature_map
   - `infer_genre()` - определяет конкретный жанр
   - ✅ Учитывает `poetic_density`, `gothic_factor`, `lyric_form_weight`
   - ⚠️ Но не всегда корректно связывает с эмоциональным профилем

3. `studiocore/emotion_genre_matrix.py`:
   - `compute_genre_bias()` - вычисляет смещение жанра на основе эмоций
   - ✅ Учитывает цвета эмоций для буста доменов
   - ⚠️ Но не всегда учитывает лирический жанр напрямую

### Необходимые исправления:
- Улучшить связь между лирическим жанром (из текста) и эмоциональным профилем
- Обеспечить, чтобы лирический жанр влиял на выбор музыкального жанра через эмоции
- Добавить явную связь: лирический жанр → эмоции → музыкальный жанр

---

## 3. Весовые коэффициенты и цветовые параметры по всей цепочке

### Текущее состояние:
- ✅ TLP веса проходят через всю цепочку
- ✅ Эмоциональные веса учитываются в genre_weights
- ⚠️ **ПРОБЛЕМА**: Цветовые параметры (`color_wave`, `color_profile`) не всегда проходят через всю цепочку

### Цепочка анализа:
1. **Вход**: Текст → `analyze()`
2. **TLP Engine**: Вычисляет `truth`, `love`, `pain` → веса
3. **Emotion Engine**: Вычисляет эмоциональный профиль → веса эмоций
4. **Color Engine**: Вычисляет `color_profile` и `color_wave` на основе эмоций
5. **Genre Weights**: Использует эмоции и цвета для определения жанра
6. **Vocal Engine**: Использует эмоции для определения вокала
7. **Style Engine**: Использует эмоции и TLP для определения стиля
8. **Выход**: `result` с `style`, `vocal`, `genre`, `color`

### Проблемы в цепочке:
- ❌ `color_wave` не передается в `style_payload` (строка 2059-2068)
- ❌ `color_wave` не передается в секции lyrics_sections
- ❌ `mood` не сохраняется в финальном `result["style"]`
- ⚠️ Цвета эмоций не всегда учитываются в genre_weights при выборе жанра

### Необходимые исправления:
1. Добавить `color_wave` в `style_payload` (строка 2059)
2. Добавить `color_wave` в каждую секцию `lyrics_sections`
3. Убедиться, что `mood` сохраняется в `result["style"]`
4. Улучшить передачу цветов через genre_weights

---

## Рекомендации по исправлению:

### Приоритет 1 (Критично):
1. Исправить сохранение `mood` и `color_wave` в `result["style"]`
2. Добавить `color_wave` в `style_payload` при создании
3. Добавить цвета в секции lyrics_sections

### Приоритет 2 (Важно):
1. Улучшить связь лирический жанр → эмоции → музыкальный жанр
2. Добавить передачу цветов в вокальные секции
3. Улучшить учет цветов в genre_weights

### Приоритет 3 (Желательно):
1. Добавить явную связь вокальных техник с цветами эмоций
2. Улучшить документацию связей между компонентами

