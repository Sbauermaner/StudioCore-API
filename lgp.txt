Отчёт аудита StudioCore (директория studiocore/*)
Дата: 2025-11-21 (UTC)

1) Пайплайн и порядок выполнения
- Фактическая последовательность analyze: текст → парсинг команд/языка → авто/ручные семантические подсказки → backend_analyze, где в рамках одного вызова запускаются emotion/tlp/section-intelligence/BPM/тональность/жанровый роутер/аннотации/Suno/FANF. Зафиксированный порядок подтверждён в теле StudioCoreV6.analyze и инициализации подсистем конструктора.【F:studiocore/core_v6.py†L95-L170】
- FANF-постобработка опирается на _last_text/_last_sections, но эти поля нигде не заполняются; build_fanf_output всегда откатывается к "" и [] даже после успешного analyze. Следствие: повторный вызов build_fanf_output выдаёт пустой текст/секции и ломает цепочку «анализ → готовые фанф-аннотации».【F:studiocore/core_v6.py†L1401-L1421】
- SectionParser добавляет технический словарь с lyrical_density/rde_emotion_hint в metadata, однако prefer_strict_boundary и сам словарь не используются ни TextStructureEngine.section_metadata, ни downstream анализом; итоговый metadata содержит запись без тегов/строк, из-за чего длина metadata больше количества секций и может смещать внешние потребители, ожидающие синхронизацию «секция ↔ метаданные».【F:studiocore/section_parser.py†L47-L69】【F:studiocore/logical_engines.py†L120-L150】

2) Согласованность движков
- Vocals engine: вокальные оверрайды применяются дважды — сразу после детекции вокала и снова в _apply_user_overrides_once, вызываемом перед финальной сборкой. Повторная мутация того же словаря создаёт дублирующиеся или конфликтующие значения (особенно при user_overrides), что даёт несогласованные подсказки между diagnostics и итоговым payload’ом вокала.【F:studiocore/core_v6.py†L448-L453】【F:studiocore/core_v6.py†L1634-L1639】
- BPM/TLP/тон: основная тональная ветка использует ToneSyncEngine.detect_key, но модификации эмоцией записываются только в служебный _tone_dynamic; финальный tonality_payload не учитывает emotion_modulation, поэтому динамическая связь «эмоция → модальный сдвиг» теряется в публичном ответе и может вести к рассинхронизации с color/tone подсказками.【F:studiocore/core_v6.py†L530-L562】
- Genre matrix/router: динамическая карта признаков собирается после zero_pulse/rem/instrumentation, но ошибки/пустые значения из legacy_core и section_intelligence не помечаются в diagnostics либо genre_analysis; клиенты не получают явного индикатора, что жанровая рекомендация построена на частично пустых данных, что нарушает ожидаемую «интегрити» жанрового движка.【F:studiocore/core_v6.py†L297-L378】【F:studiocore/core_v6.py†L620-L660】【F:studiocore/core_v6.py†L1004-L1072】

3) Логические ошибки и сериализация
- FANF state-leak: build_fanf_output хранит _last_fanf_output, но не синхронизирует текст/секции; при смене входа старые аннотации могут вернуться без пересчёта, тогда как анализ нового текста уже завершён. Это создаёт «залипание» фанф-выхода и неправильно выравнивает UI/подсказки с текущим анализом.【F:studiocore/core_v6.py†L1401-L1421】
- Дублирование оверрайдов вокала (см. п.2) приводит к неоднозначным сериализованным значениям и может затруднить парсинг JSON-клиентами, когда часть ключей перезаписана дважды с разными источниками.
- Section metadata misalignment (см. п.1) потенциально вставляет пустой словарь в JSON metadata, что может нарушить строгие схемы в интеграциях (ожидается список секций).

4) Риски для корректности анализа
- Потеря связи «эмоция→тональность» (см. п.2) ослабляет color/tone/freq слои: downstream визуализации могут показывать базовый ключ без учёта эмоциональной модуляции, хотя ToneSyncEngine рассчитан на синестезию.
- Жанровый анализ опирается на необязательные данные legacy_core/section_intelligence без явных флагов качества (см. п.2); при ошибках монолита или пустых секциях жанр и BPM возвращаются как валидные, что может привести к неверным подсказкам Suno/annotation.
- FANF-зависимость от неинициализированных полей (см. п.1) может отдать пустые аннотации, что нарушает обещанный полноценный output для UI/Choir резонанса.

Примечание: исправления не вносились; отчет фиксирует выявленные несоответствия для дальнейшего устранения.
