Отчёт аудита StudioCore-API (репозиторий: /workspace/StudioCore-API)
Дата: 2025-11-21 12:27:19 UTC

1) Общая информация
- Проект представляет собой FastAPI/Gradio-шлюз к статичному ядру StudioCore v6.4 с множеством вспомогательных модулей и тестовым набором.
- Текущие публичные эндпоинты: /status, /version, /diagnostics, /health, /healthcheck, /api/predict, корневой Gradio UI.

2) Результаты автоматических проверок
- pytest: 48 тестов пройдены успешно (команда `pytest`).

3) Наблюдения и потенциальные риски
- Конфигурационная версия: в studiocore/config.py зашита STUDIOCORE_VERSION="v4.3.1-adaptive", что расходится с заявленной v6.4; может приводить к путанице в логах/клиентах.
- Побочный побайтный доступ к файловой системе: load_config(...) создаёт/перезаписывает файл studio_config.json при импорте модуля, что нарушает требование статeless-развёртываний и может быть нежелательно на read-only FS.
- Глобальное ослабление CORS: middleware разрешает любые origin + credentials + все методы/заголовки, повышая риск CSRF/скриптовых атак при подключении к публичным фронтендам.
- Автосамопроверка при старте: auto_core_check() всегда запускает поток, через 5 секунд шлёт POST на http://127.0.0.1:7860/api/predict с таймаутом 20с. В средах без сервиса это даст лишние ошибки в логах и задержку завершения процесса при остановке.
- Конкурентность reload: _ensure_core_module() выполняет importlib.reload без блокировки; при одновременных запросах возможно состояние гонки между перезагрузкой и create_core_instance().
- Безопасность API: /api/predict не имеет аутентификации, rate limit или валидации поля gender/semantic_hints; потенциально уязвимо для злоупотреблений в публичных окружениях.
- В Gradio UI on_debug_json() выполняет HTTP-запрос без ограничений или обработки SSL/прокси, что может зависнуть при сетевых проблемах.
- Встроенная самодиагностика health выполняет реальный вызов core.analyze, что при падении ядра может дополнительно блокировать запрос и выставляет reload_required, но не логирует/обнуляет, что усложняет диагностику.
- Общие лицензционные предупреждения/«AI_TRAINING_PROHIBITED» включены во все файлы; при включении кода в сборки CI стоит удостовериться в соответствии лицензии.

4) Пайплайн и тестирование
- В репозитории отсутствует конфигурация CI/CD; проверка проводится вручную. Автоматизированный lint не настроен.
- Набор unit-тестов покрывает 48 сценариев ядра (жанровые роутеры, эмоции, BPM, секции, overrides); критических падений не выявлено.

5) Рекомендации (без внедрения изменений)
- Синхронизировать объявленную версию ядра в конфиге с фактической версией API, чтобы избежать метрик/совместимости в API-ответах.
- Избавиться от побочных эффектов при импорте конфигурации (lazy-load, опциональное создание файла или отключаемое через переменную окружения).
- Ограничить CORS/credentials для доверенных origin и добавить базовую аутентификацию либо rate limiting на /api/predict.
- Сделать самопроверку опциональной по умолчанию или уменьшить таймаут/логирование, чтобы избежать ложных срабатываний на «холодных» стартах.
- Обернуть reload логикой под блокировку или использовать copy-on-write стратегию для потокобезопасного обновления core_module.
- Добавить CI workflow с pytest и статическим анализом (ruff/pyright) для раннего обнаружения регрессий.
