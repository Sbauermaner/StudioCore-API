name: Sync HuggingFace â†’ GitHub

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout GitHub repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Git LFS
        run: |
          sudo apt-get update
          sudo apt-get install git-lfs
          git lfs install

      - name: Clone HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          rm -rf hf_temp
          git clone https://$HF_TOKEN:@huggingface.co/spaces/SBauer8/StudioCore-API hf_temp

      - name: Sync files
        run: |
          rsync -av --delete hf_temp/ ./
          rm -rf hf_temp

      - name: Commit changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add .
          git diff --cached --quiet || git commit -m "Sync from HuggingFace"

      - name: Push to GitHub (with retries)
        run: |
          n=0
          until [ "$n" -ge 5 ]
          do
            git push origin main && break
            n=$((n+1))
            echo "Retry $n/5..."
            sleep 10
          done
