name: Codex MAXI-MERGE

on:
  workflow_dispatch:

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CODEX_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.email "codex@studio.core"
          git config user.name "Codex AutoMerge"

      - name: Fetch all branches
        run: |
          git fetch --all

      - name: Fast-forward local branches
        run: |
          for BR in $(git branch -r | sed 's/origin\///'); do
            echo "Updating $BR"
            git checkout $BR || git checkout -b $BR origin/$BR
            git merge --ff-only origin/$BR || true
          done

      - name: Merge strongest patches
        run: |
          git checkout main

          for BR in $(git branch | sed 's/*//'); do
            if [ "$BR" != "main" ]; then
              echo "Trying to merge $BR"
              git merge --no-ff $BR || git merge --abort
            fi
          done

      - name: Push to main
        run: |
          git push origin main
