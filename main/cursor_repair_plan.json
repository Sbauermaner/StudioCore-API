{
    "project_repair_plan": {
      "meta": {
        "project": "StudioCore-API",
        "version": "v6.4 - maxi",
        "generated_from": [
          "main/PROZESSE_PROBLEME.md",
          "main/WIEDERHOLUNGEN_PROBLEME.md",
          "main/FUNKTIONS_STATUS_UND_HARDCODES.md",
          "main/ERGAENZENDE_ANALYSE.md"
        ],
        "objective": "Resolve architectural breaks, redundant computations, security risks, and hardcoded values."
      },
      "phases": [
        {
          "id": "PHASE_1_RESTORE_PIPELINE",
          "name": "Restore Broken Analysis Pipeline",
          "priority": "CRITICAL",
          "description": "Fix 'monolith_v4_3_1.py' where 10 out of 15 processes are currently skipped or hardcoded (Reference: PROZESSE_PROBLEME.md).",
          "target_files": [
            "studiocore/monolith_v4_3_1.py"
          ],
          "tasks": [
            {
              "task_id": "1.1",
              "issue": "TLP Analysis is passed as None to rhythm.analyze, causing incomplete rhythm calculation.",
              "location": "monolith_v4_3_1.py:536",
              "action": "Insert `tlp = self.tlp.analyze(raw)` and `cf = tlp.get('conscious_frequency')` immediately after emotion analysis."
            },
            {
              "task_id": "1.2",
              "issue": "Section Analysis (_analyze_sections) is instantiated but never called.",
              "location": "monolith_v4_3_1.py:532",
              "action": "Call `section_profiles = self._analyze_sections(text_blocks, preferred_gender)` after text block extraction."
            },
            {
              "task_id": "1.3",
              "issue": "Style.build() is skipped; code uses static FALLBACK values.",
              "location": "monolith_v4_3_1.py:556-565",
              "action": "Remove fallback hardcodes. Call `style_result = self.style.build(emotions, tlp, raw, bpm, semantic_hints, voice_hint)`."
            },
            {
              "task_id": "1.4",
              "issue": "Semantic Layers logic exists but is never invoked.",
              "location": "monolith_v4_3_1.py:314-396",
              "action": "Call `semantic_layers = self._build_semantic_layers(emotions, tlp, bpm, key)`."
            },
            {
              "task_id": "1.5",
              "issue": "Text Annotation (UI/Suno strings) is never generated.",
              "location": "monolith_v4_3_1.py:402-514",
              "action": "Call `annotated_ui, annotated_suno = self.annotate_text(text_blocks, section_profiles, semantic_layers)` before the return statement."
            },
            {
              "task_id": "1.6",
              "issue": "Vocal Allocator and Integrity Scan created but unused.",
              "location": "monolith_v4_3_1.py:230,248",
              "action": "Invoke `self.vocal_allocator.allocate(...)` and `self.integrity.scan(raw)` within the analysis flow."
            },
            {
              "task_id": "1.7",
              "issue": "Return dictionary is missing calculated data.",
              "location": "monolith_v4_3_1.py:569-575",
              "action": "Update the return dictionary to include `tlp`, `vocal`, `semantic_layers`, `integrity`, `annotated_text_ui`, and `annotated_text_suno`."
            }
          ]
        },
        {
          "id": "PHASE_2_ELIMINATE_REDUNDANCY",
          "name": "Eliminate Process Redundancy",
          "priority": "HIGH",
          "description": "Stop engines from re-analyzing text. TLP is analyzed 11 times, Emotion 9 times (Reference: WIEDERHOLUNGEN_PROBLEME.md).",
          "target_files": [
            "studiocore/vocals.py",
            "studiocore/integrity.py",
            "studiocore/monolith_v4_3_1.py"
          ],
          "tasks": [
            {
              "task_id": "2.1",
              "issue": "Vocals engine re-analyzes Emotion and TLP internally.",
              "location": "studiocore/vocals.py:387-388",
              "action": "Refactor `VocalProfileRegistry.allocate` (or `get`) to accept `emotions` and `tlp` dictionaries as arguments. Remove internal `self.emo_analyzer.analyze(text)` calls."
            },
            {
              "task_id": "2.2",
              "issue": "Integrity engine instantiates NEW analyzers and re-runs analysis.",
              "location": "studiocore/integrity.py:58-59",
              "action": "Refactor `IntegrityScanEngine.scan` to accept `emotions` and `tlp`. Remove instantiation of `AutoEmotionalAnalyzer` and `TruthLovePainEngine` inside the method."
            },
            {
              "task_id": "2.3",
              "issue": "Update calls in Monolith to match new signatures.",
              "location": "studiocore/monolith_v4_3_1.py",
              "action": "Update calls to `vocal_allocator` and `integrity` to pass the already calculated `emotions` and `tlp` variables."
            }
          ]
        },
        {
          "id": "PHASE_3_SECURITY_VALIDATION",
          "name": "Security and Input Validation",
          "priority": "HIGH",
          "description": "Address critical security gaps and missing input validation (Reference: ERGAENZENDE_ANALYSE.md).",
          "target_files": [
            "api.py",
            "studiocore/config.py",
            "studiocore/monolith_v4_3_1.py"
          ],
          "tasks": [
            {
              "task_id": "3.1",
              "issue": "No input validation in Monolith (MAX_INPUT_LENGTH check missing).",
              "location": "studiocore/monolith_v4_3_1.py:530",
              "action": "Add check: `if not text or len(text) > 16000: raise ValueError(...)` at the start of `analyze`."
            },
            {
              "task_id": "3.2",
              "issue": "CORS allows all origins ('*'), which is insecure.",
              "location": "api.py:35",
              "action": "Change `allow_origins=['*']` to use `os.getenv('CORS_ORIGINS', '').split(',')` or a strict list."
            },
            {
              "task_id": "3.3",
              "issue": "Aggression filter keywords exist but are unused.",
              "location": "studiocore/config.py:50-60",
              "action": "Implement logic to check text against `AGGRESSION_KEYWORDS` in `monolith_v4_3_1.py` before processing."
            }
          ]
        },
        {
          "id": "PHASE_4_REFACTOR_HARDCODES",
          "name": "Externalize Hardcodes",
          "priority": "MEDIUM",
          "description": "Move hardcoded values from logic files to configuration (Reference: FUNKTIONS_STATUS_UND_HARDCODES.md).",
          "target_files": [
            "studiocore/rhythm.py",
            "studiocore/config.py"
          ],
          "tasks": [
            {
              "task_id": "4.1",
              "issue": "Over 35 hardcoded values (BPM weights, thresholds, multipliers) found in rhythm.py.",
              "location": "studiocore/rhythm.py",
              "action": "Move values like `120.0` (default BPM), `0.7` (header weight), `50` (Pain boost) to `studiocore/config.py` under `DEFAULT_CONFIG`."
            },
            {
              "task_id": "4.2",
              "issue": "Punctuation weights are hardcoded locally.",
              "location": "studiocore/rhythm.py:33-40",
              "action": "Update code to reference `DEFAULT_CONFIG.PUNCT_WEIGHTS` instead of local dictionary."
            }
          ]
        },
        {
          "id": "PHASE_5_STATE_MANAGEMENT",
          "name": "Fix State Management",
          "priority": "MEDIUM",
          "description": "Fix global state leaks that violate stateless architecture (Reference: ERGAENZENDE_ANALYSE.md).",
          "target_files": [
            "studiocore/emotion.py"
          ],
          "tasks": [
            {
              "task_id": "5.1",
              "issue": "`_EMOTION_MODEL_CACHE` is a global variable causing potential thread-safety issues.",
              "location": "studiocore/emotion.py:722",
              "action": "Encapsulate the cache within the `AutoEmotionalAnalyzer` instance or implement a thread-safe singleton pattern."
            }
          ]
        }
      ]
    }
  }