# Исправления связей: Вокал → Цвета → Жанры → Веса

## Выполненные исправления:

### 1. ✅ Вокальные партии и цветовые гаммы эмоций

**Исправлено в `_build_lyrics_sections_with_vocals()`:**
- Добавлен импорт `get_emotion_colors` из `color_engine_adapter`
- Добавлено поле `color_wave` в каждую секцию `lyrics_sections`
- Цвета берутся из `EMOTION_COLOR_MAP` на основе эмоции секции
- Поле `mood` теперь использует эмоцию секции вместо "neutral"

**Результат:**
- Каждая вокальная секция теперь содержит `color_wave` с цветами эмоции
- Связь: эмоция секции → `get_emotion_colors()` → `color_wave` в секции

### 2. ✅ Лирический жанр ↔ Эмоциональный профиль ↔ Музыкальный жанр

**Текущее состояние:**
- ✅ `genre_weights.py` содержит логику конвертации лирических жанров в музыкальные
- ✅ `emotion_genre_matrix.py` связывает эмоции с жанрами через `compute_genre_bias()`
- ✅ `core_v6.py` содержит логику преобразования лирических жанров в музыкальные на основе TLP и эмоций
- ✅ Цвета эмоций учитываются в `genre_weights.py` через `color_to_domain_boost`

**Связь работает следующим образом:**
1. Лирический жанр определяется из текста (поэтическая плотность, структура)
2. Эмоциональный профиль вычисляется из текста
3. TLP (Truth, Love, Pain) вычисляется из текста
4. Музыкальный жанр определяется на основе:
   - Лирических признаков (poetic_density, lyric_form_weight)
   - Эмоционального профиля (через `compute_genre_bias()`)
   - TLP уровней (love_level, pain_level, truth_level)
   - Цветов эмоций (через `color_to_domain_boost`)

**Примеры связей:**
- Love > 0.5 + Pain < 0.5 → `lyrical_song`
- Pain > 0.6 + gothic_bias > 0.15 → `gothic_poetry`
- Truth > 0.5 + Love > 0.3 → `lyrical_song` (исповедальная лирика)

### 3. ⚠️ Весовые коэффициенты и цветовые параметры по всей цепочке

**Исправлено:**
- ✅ Добавлен `color_wave` в `style_payload` при создании (строка ~2055)
- ✅ `color_wave` берется из `color_profile` или `result.get("color", {}).get("wave")`
- ✅ Цвета передаются в вокальные секции

**Остающиеся проблемы:**
- ⚠️ `color_wave` все еще может отсутствовать в финальном `result["style"]` из-за перезаписи в `_finalize_result()`
- ⚠️ `mood` все еще может отсутствовать в финальном `result["style"]`

**Цепочка передачи:**
1. `color_wave_engine.generate_color_wave()` → `color_wave` (глобальная переменная)
2. `color_profile` → содержит `wave` и `primary_color`/`accent_color`
3. `style_payload` → должен содержать `color_wave` и `mood`
4. `result["style"]` → должен содержать `color_wave` и `mood` (НО ТЕРЯЕТСЯ В `_finalize_result()`)
5. `lyrics_sections` → содержит `color_wave` для каждой секции ✅

## Рекомендации:

### Критично:
1. Исправить сохранение `mood` и `color_wave` в `_finalize_result()` - они перезаписываются
2. Убедиться, что `style_payload` правильно передается в `result["style"]`

### Важно:
1. Улучшить логику определения `domain_genre` - сейчас может быть "unknown"
2. Добавить больше связей между лирическими жанрами и музыкальными через эмоции

### Желательно:
1. Добавить явную документацию связей между компонентами
2. Добавить тесты для проверки связей

